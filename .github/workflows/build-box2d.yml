name: Build Box2D

on:
  workflow_dispatch:
  push:
    branches:
      - issue-10617-update-box2d

env:
  DM_PACKAGES_URL: ${{ secrets.DM_PACKAGES_URL }}

jobs:
  build-linux:
    strategy:
      matrix:
        platform: [x86_64-linux]
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repo
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        ref: '${{env.BUILD_BRANCH}}'
    - name: Install Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: 3.13
    - name: Install dependencies
      run: ci/ci.sh install --platform=${{ matrix.platform }}
    - name: Build Box2D
      run: |
        ./scripts/build.py --save-env-path=ci/env.sh save_env
        source ci/env.sh
        echo "DYNAMO_HOME=$DYNAMO_HOME"
        ./scripts/build.py install_waf
        cd external/box2d
        PREFIX=$DYNAMO_HOME waf configure --platform=${{ matrix.platform }}
        waf install
    - name: Check artifact existence
      run: |
        if [ ! -f external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz ]; then
          echo "Artifact not found. Listing contents of external/box2d/build/Box2D:"
          ls -lh external/box2d/build/Box2D || echo "Directory missing"
        fi
    - name: Archive results (common)
      uses: actions/upload-artifact@v4
      with:
        name: box2d-3.1.0-common.tar.gz
        path: external/box2d/build/Box2D/box2d-3.1.0-common.tar.gz
        if-no-files-found: error
        retention-days: 1
    - name: Archive results (platform-specific)
      uses: actions/upload-artifact@v4
      with:
        name: box2d-3.1.0-${{ matrix.platform }}.tar.gz
        path: external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz
        if-no-files-found: error
        retention-days: 1

  build-linux-arm:
    strategy:
      matrix:
        platform: [arm64-linux]
    runs-on: ubuntu-22.04-arm
    steps:
        
    - name: Checkout repo
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        ref: '${{env.BUILD_BRANCH}}'
    - name: Install Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: 3.13
    - name: Install dependencies
      run: ci/ci.sh install --platform=${{ matrix.platform }}
    - name: Build Box2D
      run: |
        ./scripts/build.py --save-env-path=ci/env.sh save_env
        source ci/env.sh
        echo "DYNAMO_HOME=$DYNAMO_HOME"
        ./scripts/build.py install_waf
        cd external/box2d
        PREFIX=$DYNAMO_HOME waf configure --platform=${{ matrix.platform }}
        waf install
    - name: Check artifact existence
      run: |
        if [ ! -f external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz ]; then
          echo "Artifact not found. Listing contents of external/box2d/build/Box2D:"
          ls -lh external/box2d/build/Box2D || echo "Directory missing"
        fi
    - name: Archive results (platform-specific)
      uses: actions/upload-artifact@v4
      with:
        name: box2d-3.1.0-${{ matrix.platform }}.tar.gz
        path: external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz
        if-no-files-found: error
        retention-days: 1

  build-macos:
    strategy:
      matrix:
        platform: [arm64-macos, x86_64-macos]
    runs-on: macOS-14
    steps:
    - name: Checkout repo
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        ref: '${{env.BUILD_BRANCH}}'
    - name: Install Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: 3.13
    - name: Install dependencies
      run: ci/ci.sh install --platform=${{ matrix.platform }}
    - name: Build Box2D
      run: |
        ./scripts/build.py --save-env-path=ci/env.sh save_env
        source ci/env.sh
        echo "DYNAMO_HOME=$DYNAMO_HOME"
        ./scripts/build.py install_waf
        cd external/box2d
        PREFIX=$DYNAMO_HOME waf configure --platform=${{ matrix.platform }}
        waf install
    - name: Check artifact existence
      run: |
        if [ ! -f external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz ]; then
          echo "Artifact not found. Listing contents of external/box2d/build/Box2D:"
          ls -lh external/box2d/build/Box2D || echo "Directory missing"
        fi
    - name: Archive results (platform-specific)
      uses: actions/upload-artifact@v4
      with:
        name: box2d-3.1.0-${{ matrix.platform }}.tar.gz
        path: external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz
        if-no-files-found: error
        retention-days: 1
    
  build-windows:
    strategy:
      matrix:
        platform: [win32, x86_64-win32]
    runs-on: windows-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        ref: '${{env.BUILD_BRANCH}}'
    - name: Install Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: 3.13
    - name: Install dependencies
      run: ci/ci.sh install --platform=${{ matrix.platform }}
      shell: bash
    - name: Build Box2D
      run: |
        python ./scripts/build.py --save-env-path=ci/env.sh save_env
        ORIG_PATH="$PATH"
        # souring env.sh nukes path to python for some reason, so we save it and restore it later
        source ci/env.sh
        export PATH="$ORIG_PATH:$DYNAMO_HOME/ext/bin"
        echo "DYNAMO_HOME=$DYNAMO_HOME"
        python ./scripts/build.py install_waf
        cd external/box2d
        PREFIX=$DYNAMO_HOME waf configure --platform=${{ matrix.platform }}
        waf install
      shell: bash
    - name: Check artifact existence
      run: |
        if [ ! -f external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz ]; then
          echo "Artifact not found. Listing contents of external/box2d/build/Box2D:"
          ls -lh external/box2d/build/Box2D || echo "Directory missing"
        fi
      shell: bash
    - name: Archive results (platform-specific)
      uses: actions/upload-artifact@v4
      with:
        name: box2d-3.1.0-${{ matrix.platform }}.tar.gz
        path: external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz
        if-no-files-found: error
        retention-days: 1

  build-ios:
    strategy:
      matrix:
        platform: [arm64-ios, x86_64-ios]
    runs-on: macOS-14
    steps:
    - name: Checkout repo
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        ref: '${{env.BUILD_BRANCH}}'
    - name: Install Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: 3.13
    - name: Install dependencies
      run: ci/ci.sh install --platform=${{ matrix.platform }}
    - name: Build Box2D
      run: |
        ./scripts/build.py --save-env-path=ci/env.sh save_env
        source ci/env.sh
        echo "DYNAMO_HOME=$DYNAMO_HOME"
        ./scripts/build.py install_waf
        cd external/box2d
        PREFIX=$DYNAMO_HOME waf configure --platform=${{ matrix.platform }}
        waf install
    - name: Check artifact existence
      run: |
        if [ ! -f external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz ]; then
          echo "Artifact not found. Listing contents of external/box2d/build/Box2D:"
          ls -lh external/box2d/build/Box2D || echo "Directory missing"
        fi
    - name: Archive results (platform-specific)
      uses: actions/upload-artifact@v4
      with:
        name: box2d-3.1.0-${{ matrix.platform }}.tar.gz
        path: external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz
        if-no-files-found: error
        retention-days: 1

  build-android:
    strategy:
      matrix:
        platform: [armv7-android, arm64-android]
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repo
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

    - name: Setup NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r25b
        add-to-path: false

    - name: Install
      run: |
        sudo apt-get install -y --no-install-recommends libc6-dev-i386
        sudo apt-get install -y --no-install-recommends gcc-multilib

    - name: Install dependencies
      run: ci/ci.sh install --platform=${{ matrix.platform }}

    - name: Build Box2D
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        ./scripts/build.py --save-env-path=ci/env.sh save_env
        source ci/env.sh
        echo "DYNAMO_HOME=$DYNAMO_HOME"
        ./scripts/build.py install_waf
        cd external/box2d
        PREFIX=$DYNAMO_HOME waf configure --platform=${{ matrix.platform }}
        waf install
        
    - name: Check artifact existence
      run: |
        if [ ! -f external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz ]; then
          echo "Artifact not found. Listing contents of external/box2d/build/Box2D:"
          ls -lh external/box2d/build/Box2D || echo "Directory missing"
        fi
    - name: Archive results (platform-specific)
      uses: actions/upload-artifact@v4
      with:
        name: box2d-3.1.0-${{ matrix.platform }}.tar.gz
        path: external/box2d/build/Box2D/box2d-3.1.0-${{ matrix.platform }}.tar.gz
        if-no-files-found: error
        retention-days: 1