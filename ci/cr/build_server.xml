<project name="de.vogella.build" default="build">
    <!--sets the path of the properties file-->
    <property file="build.properties" />

    <!-- For eclipse 3.7.2 -->
    <!-- property name="pdeBuildPluginVersion" value="3.7.0.v20111116-2009" />-->
    <!-- For eclipse 3.7.1 -->
    <property name="pdeBuildPluginVersion" value="3.8.2.v20121114-140810" />

    <property name="equinoxLauncherPluginVersion" value="1.3.0.v20120522-1813" />
    <property name="eclipseLocation" value="${baseLocation}" />
    <property environment="env"/>

    <!-- NOTE: We skip clean. Ant *follows* symlinks - dangerous !
	 build.sh takes care of cleaning
      -->
    <target name="clean">
      <!-- <delete dir="${buildDirectory}" />-->
    </target>

    <target name="init">
        <ant dir="${buildDirectory}/plugins/com.dynamo.cr.common" antfile="build.xml"/>

        <!-- pushd not availble in dash.
             That's the reason for expicit bash below -->
        <exec dir="${buildDirectory}/plugins/com.dynamo.cr.templates"
              executable="bash" failonerror="true">
              <arg value="scripts/copy_templates.sh"/>
        </exec>

    </target>

    <!--
        This target actually executes the PDE Build process by launching the
        Eclipse antRunner application.
    -->
    <target name="pde-build">
        <java classname="org.eclipse.equinox.launcher.Main" fork="true" failonerror="true">
            <arg value="-application" />
            <arg value="org.eclipse.ant.core.antRunner" />
            <arg value="-buildfile" />
            <arg value="${eclipseLocation}/plugins/org.eclipse.pde.build_${pdeBuildPluginVersion}/scripts/productBuild/productBuild.xml" />
            <arg value="-Dtimestamp=${timestamp}" />
            <arg value="-DbaseLocation=${baseLocation}" />
            <arg value="-DbuildDirectory=${buildDirectory}" />
            <arg value="-DbuildProperties=${buildProperties}" />
            <classpath>
                <pathelement location="${baseLocation}/plugins/org.eclipse.equinox.launcher_${equinoxLauncherPluginVersion}.jar" />
            </classpath>
        </java>
    </target>

    <target name="test">

        <!-- ant copy doesn't preserve permissions... -->
    	<chmod dir="${buildDirectory}/plugins/com.dynamo.cr.server" perm="+x" includes="scripts/*.sh"/>

        <java classname="org.eclipse.equinox.launcher.Main" fork="true" failonerror="true" dir="${buildDirectory}/plugins/com.dynamo.cr.server">
            <arg value="-application" />
            <arg value="org.eclipse.ant.core.antRunner" />
            <arg value="-buildfile" />
            <arg value="test.xml" />
            <arg value="-DECLIPSE_HOME=${eclipseLocation}" />
            <arg value="GitTest" />
            <arg value="junitreport" />
            <classpath>
                <pathelement location="${baseLocation}/plugins/org.eclipse.equinox.launcher_${equinoxLauncherPluginVersion}.jar" />
            </classpath>
        </java>
    </target>

	<!--This target is responsible for cleaning up the build-directory
    <target name="clean">
        <delete dir="${buildDirectory}" />
    </target>-->

    <!--This target defines the run-order of the targets-->
    <target name="build" depends="clean, init, pde-build" />
</project>
