#! /usr/bin/env python

import sys, os

import Task, TaskGen, Options
from TaskGen import extension, declare_extension

sys.path.insert(0, "src")
import waf_gamesys

if sys.platform == "win32":
    os.environ["PYTHONPATH"] = os.environ["PYTHONPATH"] + ";default/proto;../src"
else:
    os.environ["PYTHONPATH"] = os.environ["PYTHONPATH"] + ":default/proto:../src"

def configure(conf):
    pass

def build(bld):
    dirs = ['animationset',
            'camera',
            'collection_proxy',
            'collision_object',
            'convex_shape',
            'emitter',
            'factory',
            'collection_factory',
            'font',
            'fragment_program',
            'gui',
            'input',
            'label',
            'light',
            'material',
            'meshset',
            'model',
            'particlefx',
            'render',
            'render_script',
            'display_profiles',
            'resource',
            'script',
            'sound',
            'spine',
            'sprite',
            'tile',
            'texture',
            'textureset',
            'vertex_program',
            'window']
    exts = ['animationset',
            'camera',
            'collisionobject',
            'convexshape',
            'emitter',
            'factory',
            'collectionfactory',
            'font',
            'fp',
            'gui',
            'gui_script',
            'gamepads',
            'input_binding',
            'jpg',
            'label',
            'light',
            'material',
            'meshset',
            'model',
            'particlefx',
            'png',
            'render',
            'render_script',
            'display_profiles',
            'resource',
            'script',
            'sprite',
            'vp',
            'wav',
            'sound',
            'spinescene',
            'spinemodel']

    test_task_gen = bld.new_task_gen(features = 'cxx cprogram test',
                                     includes = '../../../src ../../../proto %s' % (dir),
                                     uselib = 'DMGLFW GAMEOBJECT DDF RESOURCE GRAPHICS_UTIL PHYSICS RENDER GRAPHICS_NULL PLATFORM_SOCKET SCRIPT LUA EXTENSION INPUT HID_NULL PARTICLE RIG GUI SOUND_NULL DLIB LIVEUPDATE CARES',
                                     uselib_local = 'gamesys',
                                     web_libs = ['library_sys.js', 'library_script.js'],
                                     proto_gen_py = True,
                                     content_root='.',
                                     target = 'test_gamesys')
    test_task_gen.source = ["test_gamesys.cpp"]
    test_task_gen.find_sources_in_dirs(' '.join(dirs), exts)
    test_task_gen.install_path = None

    test_buffer_task_gen = bld.new_task_gen(features = 'cxx cprogram test',
                                     includes = '../../../src ../../../proto %s' % (dir),
                                     uselib = 'DMGLFW GAMEOBJECT DDF RESOURCE GRAPHICS_UTIL PHYSICS RENDER GRAPHICS_NULL PLATFORM_SOCKET SCRIPT LUA EXTENSION INPUT HID_NULL PARTICLE RIG GUI SOUND_NULL DLIB LIVEUPDATE CARES',
                                     uselib_local = 'gamesys',
                                     web_libs = ['library_sys.js', 'library_script.js'],
                                     proto_gen_py = True,
                                     content_root='.',
                                     target = 'test_script_buffer')
    test_buffer_task_gen.find_sources_in_dirs(' '.join(dirs), exts)
    test_buffer_task_gen.source = ["test_script_buffer.cpp"]
    test_buffer_task_gen.install_path = None

    if not bld.env.PLATFORM in ('armv7-darwin', 'arm64-darwin', 'arm64-android', 'x86_64-ios') and not Options.options.with_vulkan:
        bld.add_subdirs('fontview')
