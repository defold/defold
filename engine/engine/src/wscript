#! /usr/bin/env python
import os, re

def set_options(opt):
    pass

def build(bld):
    obj = bld.new_task_gen(features = 'cxx cstaticlib ddf embed',
                          includes = '../proto .',
                          target = 'engine',
                          proto_gen_py = True,
                          protoc_includes = '../proto',
                          embed_source='../content/materials/debug.vpc ../content/materials/debug.fpc ../content/builtins.arc ../content/builtins/connect/connect.project',
                          source='engine.cpp engine_service.cpp physics_debug_render.cpp profile_render.cpp ../proto/engine_ddf.proto')
    bld.install_files('${PREFIX}/include/engine', 'engine.h')
    bld.install_files('${PREFIX}/share/proto', '../proto/engine_ddf.proto')

    additional_libs = []
    exported_symbols = []
    if  re.match('arm.*?darwin', bld.env['PLATFORM']):
        additional_libs.append('FACEBOOK')
        additional_libs.append('SQLLITE')
        exported_symbols = ['FacebookExt']

    if 'android' in bld.env['PLATFORM']:
        sound_lib = 'SOUND OPENAL_SOFT OPENSLES'
        exported_symbols = ['FacebookExt']
    elif 'js-web' in bld.env['PLATFORM']:
        sound_lib = 'SOUND_NULL'
    else:
        sound_lib = 'SOUND OPENAL'

    additional_libs = ' '.join(additional_libs)
    
    dynamo_home = os.getenv('DYNAMO_HOME')

    obj = bld.new_task_gen(
        features = 'cc cxx cprogram apk',
        uselib = 'FACEBOOKEXT RECORD VPX GAMEOBJECT DDF RESOURCE GAMESYS GRAPHICS GRAPHICS_UTIL PHYSICS RENDER PLATFORM_SOCKET LUA SCRIPT EXTENSION HID INPUT PARTICLE DLIB DMGLFW GUI %s ALUT X %s' % (sound_lib, additional_libs),
        uselib_local = 'engine',
        exported_symbols = exported_symbols,
        includes = '../build ../proto .',
        #NOTE: _XBOX to get static lib and avoid dllimport/dllexport stuff
        defines = '_XBOX',
        proto_gen_py = True,
        protoc_includes = '../proto',
        target = 'dmengine',
        source=['main.cpp'],
        activities=['com.facebook.LoginActivity'],
        jars=['%s/ext/share/java/facebooksdk.jar' % (dynamo_home),
              '%s/ext/share/java/android-support-v4.jar' % (dynamo_home),
              '%s/share/java/facebook_android.jar' % (dynamo_home),
              '%s/share/java/gamesys_android.jar' % (dynamo_home)])

    obj = bld.new_task_gen(
        features = 'cc cxx cprogram apk',
        uselib = 'FACEBOOKEXT RECORD VPX GAMEOBJECT DDF RESOURCE GAMESYS GRAPHICS GRAPHICS_UTIL PHYSICS RENDER PLATFORM_SOCKET LUA SCRIPT EXTENSION HID INPUT PARTICLE DLIB DMGLFW GUI %s ALUT X %s' % (sound_lib, additional_libs),
        uselib_local = 'engine',
        includes = '../build ../proto .',
        #NOTE: _XBOX to get static lib and avoid dllimport/dllexport stuff
        defines = '_XBOX DM_RELEASE=1',
        proto_gen_py = True,
        protoc_includes = '../proto',
        target = 'dmengine_release',
        source=['main.cpp'],
        activities=['com.facebook.LoginActivity'],
        jars=['%s/ext/share/java/facebooksdk.jar' % (dynamo_home),
              '%s/ext/share/java/android-support-v4.jar' % (dynamo_home),
              '%s/share/java/facebook_android.jar' % (dynamo_home),
              '%s/share/java/gamesys_android.jar' % (dynamo_home)])

    if bld.env.BUILD_PLATFORM == 'win32':
        obj.source.append('engine.rc')

    obj = bld.new_task_gen(
        features = 'cc cxx cprogram',
        uselib = 'RECORD VPX GAMEOBJECT DDF RESOURCE GAMESYS GRAPHICS_NULL GRAPHICS_UTIL PHYSICS RENDER PLATFORM_SOCKET LUA SCRIPT EXTENSION HID_NULL INPUT PARTICLE GUI SOUND_NULL DLIB DMGLFW X',
        uselib_local = 'engine',
        includes = '../build ../proto .',
        proto_gen_py = True,
        protoc_includes = '../proto',
        target = 'dmengine_headless',
        source='main.cpp')

    bld.new_task_gen(source = '../proto/engine_ddf.proto',
                     target = 'engine_doc.sdoc',
                     rule = '${SCRIPT_DOC} ${SRC} ${TGT}')

    bld.new_task_gen(source = '../proto/engine_ddf.proto',
                     target = 'engine_doc.json',
                     rule = '${SCRIPT_DOC} -t json ${SRC} ${TGT}')

    bld.install_files('${PREFIX}/share/doc', 'engine_doc.sdoc')
    bld.install_files('${PREFIX}/share/doc', 'engine_doc.json')

    bld.add_subdirs('test')

def configure(conf):
    pass
