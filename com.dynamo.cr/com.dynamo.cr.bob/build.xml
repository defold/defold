<project default="dist">
    <property environment="env"/>
    <property name="classes.dir" value="build"/>

    <path id="classpath">
        <fileset dir="lib" includes="*.jar"/>
        <fileset dir="../com.dynamo.cr.common/ext" includes="protobuf-java*.jar"/>
        <fileset dir="../com.dynamo.cr.common/ext" includes="commons*.jar"/>
        <fileset dir="../com.dynamo.cr.common/ext" includes="vecmath.jar"/>
        <fileset dir="lib" includes="*.jar"/>
    </path>

    <macrodef name="proto">
        <attribute name="dir"/>
        <attribute name="file"/>

        <sequential>
            <mkdir dir="generated"/>
            <exec executable="protoc" failonerror="true">
                <arg value="--java_out=generated"/>
                <arg value="-I@{dir}"/>
                <arg value="-I${env.DYNAMO_HOME}/ext/include"/>
                <arg value="-I../../engine/ddf/src"/>
                <arg value="@{dir}/@{file}"/>
            </exec>
        </sequential>
    </macrodef>

    <target name="clean">
        <delete dir="${classes.dir}"/>
        <delete dir="generated"/>
        <delete dir="dist"/>
        <delete dir="tmp"/>
    </target>

    <target name="compile">
        <mkdir dir="${classes.dir}"/>
        <!-- NOTE: We force thread-count 10 here in order to reduce latency
             Running external processes in Java is slow -->
        <parallel threadCount="20">
            <proto dir="../../engine/ddf/src" file="ddf/ddf_extensions.proto"/>
            <proto dir="../../engine/ddf/src" file="ddf/ddf_math.proto"/>
            <proto dir="../../engine/engine/proto" file="engine_ddf.proto"/>
            <proto dir="../../engine/gameobject/proto" file="properties_ddf.proto"/>
            <proto dir="../../engine/gameobject/proto" file="gameobject_ddf.proto"/>
            <proto dir="../../engine/gameobject/proto" file="lua_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="atlas_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="camera_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="gamesys_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="gui_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="mesh_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="model_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="physics_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="sound_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="sprite_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="texture_set_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="tile_ddf.proto"/>
            <proto dir="../../engine/gamesys/proto/" file="spine_ddf.proto"/>
            <proto dir="../../engine/graphics/proto" file="graphics_ddf.proto"/>
            <proto dir="../../engine/input/proto" file="input_ddf.proto"/>
            <proto dir="../../engine/particle/proto/particle" file="particle_ddf.proto"/>
            <proto dir="../../engine/render/proto/render" file="font_ddf.proto"/>
            <proto dir="../../engine/render/proto/render" file="material_ddf.proto"/>
            <proto dir="../../engine/render/proto/render" file="render_ddf.proto"/>
            <proto dir="../../engine/resource/proto" file="resource_ddf.proto"/>
            <proto dir="../../engine/script/proto" file="script_doc_ddf.proto"/>
            <proto dir="../../engine/vscript/proto" file="vscript_ddf.proto"/>
        </parallel>

        <!-- extdirs="foo" is set to avoid automatic inclusion of ext-jars and
             specifically vecmath.jar on OSX -->
        <javac srcdir="generated"
               destdir="${classes.dir}"
               extdirs="foo"
               includeantruntime="false">
            <classpath>
                <path refid="classpath"/>
            </classpath>
            <compilerarg value="-g"/>
        </javac>

        <javac destdir="${classes.dir}"
               extdirs="foo"
               includeantruntime="false">
            <src path="src"/>
            <include name="com/**"/>
            <exclude name="com/dynamo/bob/*Osgi*"/>

            <classpath>
                <path refid="classpath"/>
            </classpath>
            <compilerarg value="-g"/>
        </javac>

        <copy todir="${classes.dir}">
            <fileset dir="src" includes="**/*.properties" />
        </copy>
    </target>

    <target name="dist" depends="compile">
        <mkdir dir="dist"/>
        <mkdir dir="tmp"/>

        <jar jarfile="tmp/external-libs.jar">
            <zipgroupfileset dir="../com.dynamo.cr.common/ext">
              <include name="protobuf-java*.jar"/>
              <include name="commons*.jar"/>
              <include name="vecmath.jar"/>
            </zipgroupfileset>
            <zipgroupfileset dir="lib">
              <include name="*.jar"/>
            </zipgroupfileset>
         </jar>

        <jar destfile="dist/bob-light.jar">
            <fileset dir="${classes.dir}"/>
            <zipfileset src="tmp/external-libs.jar">
              <exclude name="**/META-INF/**"/>
            </zipfileset>

            <manifest>
                <attribute name="Main-Class" value="com.dynamo.bob.Bob"/>
            </manifest>

        </jar>
    </target>

    <target name="dist-builtins" depends="compile">
        <mkdir dir="dist"/>
        <mkdir dir="tmp"/>

        <jar jarfile="tmp/external-libs-builtins.jar">
            <zipgroupfileset dir="../com.dynamo.cr.common/ext">
              <include name="protobuf-java*.jar"/>
              <include name="commons*.jar"/>
              <include name="vecmath.jar"/>
            </zipgroupfileset>
            <zipgroupfileset dir="lib">
              <include name="*.jar"/>
            </zipgroupfileset>
         </jar>

        <jar destfile="dist/bob.jar">
            <fileset dir="${classes.dir}"/>
            <zipfileset src="lib/builtins.zip"/>
            <zipfileset src="tmp/external-libs-builtins.jar">
              <exclude name="**/META-INF/**"/>
            </zipfileset>

            <manifest>
                <attribute name="Main-Class" value="com.dynamo.bob.Bob"/>
            </manifest>

        </jar>
    </target>

    <target name="install" depends="dist">
        <copy file="dist/bob-light.jar" todir="${env.DYNAMO_HOME}/share/java"/>
    </target>

    <target name="install-builtins" depends="dist-builtins">
        <copy file="dist/bob.jar" todir="${env.DYNAMO_HOME}/share/java"/>
    </target>

    <target name="install-full" depends="install,install-builtins" />

</project>
